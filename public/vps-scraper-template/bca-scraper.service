[Unit]
Description=BCA Scraper Daemon - Persistent Browser Mode
After=network-online.target
Wants=network-online.target
Requires=network-online.target

# Restart rate limiting - max 5 restarts in 5 minutes
StartLimitIntervalSec=300
StartLimitBurst=5

[Service]
Type=simple
WorkingDirectory=/root/bca-scraper

# Pre-start checks
ExecStartPre=/bin/bash -c 'echo "=== BCA Scraper Service Starting ===" >> /var/log/bca-scraper.log'
ExecStartPre=/bin/bash -c 'echo "Timestamp: $(date -Iseconds)" >> /var/log/bca-scraper.log'
ExecStartPre=/bin/bash -c 'test -f /root/bca-scraper/config.env || (echo "ERROR: config.env not found" >> /var/log/bca-scraper.log && exit 1)'
ExecStartPre=/bin/bash -c 'test -f /root/bca-scraper/bca-scraper.js || (echo "ERROR: bca-scraper.js not found" >> /var/log/bca-scraper.log && exit 1)'

# Kill any orphan chromium processes before starting
ExecStartPre=/bin/bash -c 'pkill -f "chromium.*puppeteer" 2>/dev/null || true'

# Wait for network
ExecStartPre=/bin/bash -c 'sleep 3'

# Main process - Persistent Browser Mode (single daemon)
ExecStart=/usr/bin/node /root/bca-scraper/bca-scraper.js

# Post-stop logging
ExecStopPost=/bin/bash -c 'echo "BCA Scraper stopped with exit code: $EXIT_STATUS at $(date -Iseconds)" >> /var/log/bca-scraper.log'

# Kill orphan processes on stop
ExecStopPost=/bin/bash -c 'pkill -f "chromium.*puppeteer" 2>/dev/null || true'

# Restart configuration
Restart=always
RestartSec=30

# Watchdog - systemd will restart if no response in 10 minutes
WatchdogSec=600

# Resource limits
MemoryMax=600M
CPUQuota=80%
TasksMax=100
LimitNOFILE=65535

# Logging
StandardOutput=append:/var/log/bca-scraper.log
StandardError=append:/var/log/bca-scraper-error.log
SyslogIdentifier=bca-scraper

# Environment
Environment=NODE_ENV=production
Environment=NODE_OPTIONS=--max-old-space-size=512
Environment=TZ=Asia/Jakarta
EnvironmentFile=/root/bca-scraper/config.env

# Security
PrivateTmp=true
ProtectSystem=strict
ReadWritePaths=/root/bca-scraper /var/log /tmp

# Timeouts
TimeoutStartSec=60
TimeoutStopSec=30

[Install]
WantedBy=multi-user.target
